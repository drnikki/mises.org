/*! Spyglass - 0.0.1 */

SG=Em.Namespace.create();var utils={};utils.parseQueryString=function(e){for(var t=e.split("&"),s={},r=0;t.length>r;r++){var a,c=t[r].split("="),n=decodeURI(c[0]);a="fq"===n?this.parseFqString(c[1]):decodeURI(c[1]),s[n]=a}return s},utils.returnSearchHash=function(e,t,s){var r=[];return e&&""!==e&&r.push("q="+(""+e)),t&&""!==t&&r.push("fq="+t.replace(/\//g,"::")),s&&""!==s&&r.push("sort="+s),encodeURI(r.join("&"))},utils.parseFqString=function(e){for(var t=decodeURIComponent(""+e).replace(/\::/g,"/").split(","),s={},r=RegExp("[:]+(?![^[]*])"),a=0;t.length>a;a++){var c=t[a].split(r),n=c[0],i=c[1]?c[1]:!1;if(!i)return;if(s[n]){var h=s[n];Array.isArray(h)?s[n].push(i):s[n]=[h,i]}else s[n]=i}return s},utils.formatISODate=function(e,t){var s=""+e,r=s.slice(8,10),a=s.slice(5,7),c=s.slice(0,4),n=(s.slice(11,13),s.slice(14,16),s.slice(17,19),["Jan","Feb","Mar","Apr","May","Jun","Jul","Aug","Sep","Oct","Nov","Dec"]);return"date"===t?n[Number(a)-1]+" "+Number(r)+", "+c:"year"===t?c:void 0},$(document).ready(function(){$(window).scroll(function(){var e=$(document).height()-$(window).scrollTop(),t=$(window).height(),s=App.searcher.get("allResultsLoaded");!s&&!App.searcher.isSearching&&window.location.hash.indexOf("search")>-1&&t+360>e&&App.searcher.loadNextResults()})}),SG.Searcher=Em.ObjectController.extend({params:{},url:null,searchResponse:null,isSearching:null,responseTime:null,submitSearch:function(e){if(this.params.q){this.params.start=0,"sort"!==e&&this.clearFacets();var t="/search/"+utils.returnSearchHash(this.params.q,this.getSelectedFacets(),this.params.sort);window.location.hash=t}},numFound:function(){var e=function(e){return(""+e).replace(/\B(?=(\d{3})+(?!\d))/g,",")};if(this.searchResponse){var t=this.searchResponse.response.numFound;return 3>(""+t).length?t:e(t)}return!1}.property("searchResponse"),allResultsLoaded:function(){var e=parseInt((""+this.get("numFound")).replace(/[^0-9]/g,""),10);return e>this.params.start||!e?!1:!0}.property("numFound","isSearching"),noResults:function(){var e=parseInt((""+this.get("numFound")).replace(/[^0-9]/g,""),10);return 0!==e||this.isSearching?!1:!0}.property("numFound","isSearching"),searchedFor:null,search:function(){var e=this;e.set("isSearching",!0),e.set("searchedFor",e.params.q),e.set("responseTime",(new Date).getTime()),$.ajax({url:this.url,data:this.params,traditional:!0,cache:!0,success:function(t){e.set("isSearching",!1);var s=(new Date).getTime();e.set("searchResponse",t),e.success(),e.set("responseTime",s-e.responseTime)},statusCode:{400:function(){throw e.set("isSearching",!1),"Search Error"}},dataType:"jsonp",jsonp:"json.wrf",beforeSend:function(){}})},loadNextResults:function(){var e=this.get("allResultsLoaded"),t=this.get("noResults"),s=this.get("isSearching");e||t||s||this.search()},setQuery:function(){throw"Implement a setQuery method for your searcher"},addFacet:function(){throw"Implement an addFacet method for your searcher"},getResults:function(){throw"Implement a getResults method on your searcher"},getFacets:function(){throw"Implement a getFacets method on your searcher"},getHighlights:function(){throw"Implement a getFacets method on your searcher"},success:function(){throw"Implement a success method on your searcher"}}),SG.SolrSearcher=SG.Searcher.extend({params:{wt:"json",fq:[]},setQuery:function(e){var t=e.replace(/( and | not | or )/g,function(e){return e.toUpperCase()});this.params.q=t},getResults:function(){return this.searchResponse.response.docs},getHighlights:function(){return this.searchResponse.highlighting},getFacets:function(){var e=this,t=function(t,s){for(var r=[],a=0;s.length>a;a+=2){var c=s[a],n=s[a+1];n>0&&r.push({value:c,count:n,fieldName:t,selectFacet:function(){e.addFacet(this.fieldName,'"'+this.value+'"',!0)}})}return r},s=[],r=this.get("searchResponse").facet_counts.facet_fields;for(var a in r){var c={facetField:a,facets:[]};c.facets=t(a,r[a]),s.push(c)}var n=function(e){var t=e,s=(Number(t.slice(0,4))+1,t.substring(0,4)+"-12-31T23:59:59Z");return"["+t+" TO "+s+"]"},i=function(t,s){var r=[];for(var a in s)year=utils.formatISODate(a,"year"),count=s[a],count>0&&r.push({value:year,range:n(a),count:count,fieldName:t,selectFacet:function(){e.addFacet(this.fieldName,this.range,!0)}});return r.reverse(),r},h=this.get("searchResponse").facet_counts.facet_dates;for(var o in h){var u={facetField:o,facets:[]};u.facets=i(o,h[o]),s.push(u)}return s},updateFq:function(){this.params.fq=this.getSelectedFacets("array")},clearFacets:function(){this.selectedFacets.clear(),this.updateFq()},addFacet:function(e,t,s){var r=this;if(r.selectedFacets.addObject({field:e,value:t,removeFacet:function(){r.selectedFacets.removeObject(this),r.params.start=0,r.updateFq()}}),r.updateFq(),s){r.params.start=0;var a="/search/"+utils.returnSearchHash(r.params.q,this.getSelectedFacets(),r.params.sort);window.location.hash=a}},selectedFacets:Em.ArrayController.create({content:[]}),getSelectedFacets:function(e){for(var t=this.get("selectedFacets.content"),s=[],r=0;t.length>r;r++){var a,c=t[r].field,n=t[r].value,i=typeof n;if("string"===i)a=c+":"+n,s.push(a);else if("object"===i)for(var h in n)n.hasOwnProperty(h)&&(a=c+":"+n[h],s.push(a))}return"array"===e?s:s.join(",")},removeSelectedFacet:function(e){e.removeFacet();var t=this.get("params"),s="/search/"+utils.returnSearchHash(t.q,this.getSelectedFacets(),t.sort);window.location.hash=s}}),SG.SearcherObserver=Em.View.extend({searcher:null,doUpdate:function(){this.update()}.observes("searcher.searchResponse"),update:function(){throw"Classes that extend SG.SearcherObserver must implement the update method."}}),SG.ResultSet=SG.SearcherObserver.extend({templateName:"results",results:null,highlights:null,update:function(){var e=this.searcher.getResults();0===this.searcher.params.start&&this.set("results",[]);for(var t=0;e.length>t;t++)this.results.addObject(e[t]);this.searcher.params.start+=this.searcher.params.rows,this.searcher.set("searchedFor",this.searcher.params.q)}}),SG.SearchBox=Ember.TextField.extend({placeholder:"Search Keywords",name:"searchInput",expanded:!1,classNames:null,didInsertElement:function(){this.searcher.searchedFor&&this.set("value",this.searcher.searchedFor)},update:function(){this.set("value",this.searcher.searchedFor)}.observes("searcher.searchedFor"),search:function(){this.searcher.clearFacets(),this.searcher.submitSearch()},keyUp:function(){var e=(""+this.value).replace(/\:\s/g,":");this.searcher.setQuery(e)},keyDown:function(e){13===e.keyCode&&(e.preventDefault(),e.stopPropagation(),this.search())}}),SG.SearchSubmit=Ember.View.extend({tagName:"input",type:"submit",click:function(){self.params.start=0,self.clearFacets(),this.searcher.setQuery(this.value),this.searcher.search()}}),SG.FacetGroup=SG.SearcherObserver.extend({update:function(){var e=this.searcher.getFacets(),t=this;e.forEach(function(e){if(e.facetField===t.fieldName){t.set("facets",e.facets);var s=[];e.facets.forEach(function(e){var r=t.facetClass.create(e);r.set("searcher",t.searcher),s.push(r)}),t.set("facets",s)}})},templateName:"facet-group",searcher:null,fieldName:null,displayName:null,facets:[],facetClass:Em.View.extend({template:Em.Handlebars.compile('<li><a href="">{{value}}</a> <span>({{count}})</span></li>'),click:function(e){e.preventDefault(),e.stopPropagation(),this.selectFacet()}})}),Ember.TEMPLATES["facet-group"]=Em.Handlebars.compile('  {{#if view.facets}}<h3>{{{view.displayName}}}</h3>  <ul class="facets-list">    {{#each view.facets }}      {{view this}}    {{/each}}  </ul>{{/if}}');